name: Tests and Quality Checks

on:
    push:
        branches: [main, develop, refactor]
    pull_request:
        branches: [main, develop, refactor]

jobs:
    test:
        name: Run Tests
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [18.x, 20.x]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run TypeScript type check
              run: pnpm type-check
              continue-on-error: true # Continue for now due to existing service errors

            - name: Run ESLint
              run: pnpm lint
              continue-on-error: true # Continue for now, improve gradually

            - name: Run tests with coverage
              run: pnpm test:ci

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              if: matrix.node-version == '20.x'
              with:
                  file: ./coverage/lcov.info
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: false

            - name: Comment coverage on PR
              if: github.event_name == 'pull_request' && matrix.node-version == '20.x'
              uses: romeovs/lcov-reporter-action@v0.3.1
              with:
                  lcov-file: ./coverage/lcov.info
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  delete-old-comments: true

    build:
        name: Build Check
        runs-on: ubuntu-latest
        needs: test

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20.x'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build project
              run: pnpm build
              env:
                  # Node environment
                  NODE_ENV: production
                  
                  # Public env vars
                  NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID: 'dummy-walletconnect-project-id-for-ci'
                  NEXT_PUBLIC_APP_URL: https://test.example.com
                  NEXT_PUBLIC_HEDERA_NETWORK: testnet
                  NEXT_PUBLIC_HEDERA_MIRROR_NODE_URL: https://testnet.mirrornode.hedera.com
                  NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
                  NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJkdW1teSIsInJvbGUiOiJhbm9uIn0.dummy
                  
                  # Hedera configuration
                  HEDERA_NETWORK: testnet
                  USE_REAL_TESTNET: 'true'
                  
                  # Hedera Operators (dummy values - valid format but test keys)
                  DEPOSIT_WALLET_ID: '0.0.12345'
                  DEPOSIT_WALLET_KEY: '302e020100300506032b657004220420000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f'
                  INSTANT_WITHDRAW_WALLET_ID: '0.0.12346'
                  INSTANT_WITHDRAW_WALLET_KEY: '302e020100300506032b657004220420202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f'
                  EMISSIONS_ID: '0.0.12347'
                  EMISSIONS_KEY: '302e020100300506032b657004220420404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f'
                  RATE_PUBLISHER_ID: '0.0.12350'
                  RATE_PUBLISHER_KEY: '302e020100300506032b657004220420606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f'
                  
                  # Tokens
                  USDC_TOKEN_ID: '0.0.12348'
                  HUSD_TOKEN_ID: '0.0.12349'
                  
                  # Topics
                  TOPIC_ID: '0.0.12351'
                  WITHDRAW_TOPIC_ID: '0.0.12352'
                  
                  # Auth
                  JWT_SECRET: 'dummy-jwt-secret-for-ci-build-only-not-for-production-use-minimum-32-chars'
                  
                  # Supabase
                  SUPABASE_SERVICE_ROLE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJkdW1teSIsInJvbGUiOiJzZXJ2aWNlX3JvbGUifQ.dummy
